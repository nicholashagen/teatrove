<% template script_admin_core ()

    pathPrefix = call system.util.getPathPrefix();

    setContentType("text/javascript;charset=utf-8");

%>

;(function($) {

    var global = this;

    /* ajax setup */
    $.ajaxSetup({ cache: false });
    
    /* model */
    global.Admin = {
        id: "Admin"
        ,version: "0.1"
    };

    var templateInterval;

    /* nav */
    $('header a').live('click', function (evt) {
        if ( $(this).attr('href') == '#' ) {
            evt.preventDefault();
        }
    });

    /* tree */
    function expandTreeNode (elemId) {
        if ( elemId ) {
            var node = $('#'+elemId);
            if ( node.is('.jstree-closed') ) {
                node.removeClass('jstree-closed').addClass('jstree-open');
            }
        }
    };
    function collapseTreeNode (elemId) {
        if ( elemId ) {
            var node = $('#'+elemId);
            if ( node.is('.jstree-open') ) {
                node.removeClass('jstree-open').addClass('jstree-closed');
            }
        }
    };
    function toggleTreeNode (elemId) {
        if ( elemId ) {
            var node = $('#'+elemId);
            if ( node.is('.jstree-open') ) {
                collapseTreeNode(elemId);
            } else if ( node.is('.jstree-closed') ) {
                expandTreeNode(elemId);
            }
        }
    };
    function toggleTreeNodes () {
        // toggle all
        $('#tree-container li').each( function (i, val) {
            var elemId = $(this).attr("id");
            toggleTreeNode(elemId);
        });
    };
    function toggleAnimation () {
        // toggle animation
        var anim = $("#toggleAnimation").attr("anim");
        if ( anim != '0' ) {
            $("#tree-container").jstree( { "core" : { "animation" : 100 } } );
            $("#toggleAnimation").attr("anim", 100);
        } else {
            $("#tree-container").jstree( { "core" : { "animation" : 0 } } );
            $("#toggleAnimation").attr("anim", 0);
        }
    };
    function expandTreeNodes () {
        // expand all
        $('#tree-container li').each( function (i, val) {
            var elemId = $(this).attr("id");
            expandTreeNode(elemId);
        });
    };
    function collapseTreeNodes () {
        // collapse all
        $('#tree-container li').each( function (i, val) {
            var elemId = $(this).attr("id");
            collapseTreeNode(elemId);
        });
    };
    function filterTreeNodes () {
        var regex;
        try {
            var pattern = $('#tree-search-text').val();
            if ( pattern == '' ) {
                return true;
            }
            regex = new RegExp(pattern, 'ig');

            $('#tree-search-text').css('border-color', 'green');
            $("#tree-container ul li").each( function(i, val) {
                var text = $(this).text();
                if ( regex.test(text) ) {
                    $(this).find('a').addClass('jstree-search');
                    $(this).show();
                    var parentNode = $(this).parent('ul').parent('li');
                    if ( parentNode ) {
                        var elemId = parentNode.attr('id');
                        expandTreeNode(elemId);
                    }
                } else {
                    $(this).find('a').removeClass('jstree-search');
                    if ( $(this).attr('rel') != 'parameter' ) {
                        $(this).hide();
                    }
                }
            });
        } catch(e) {
            $('#tree-search-text').css('border-color', 'red');
            $("#tree-container ul li a.jstree-search").removeClass('jstree-search');
            $("#tree-container ul li").show();
        }
    };
    function initTree () {
        var $window = $(window),
            $detailsContent = $('#details-content'),
            $detailsParent = $detailsContent.parent(),
            $treeContainer = $('#tree-container'),
            $detailsSection = $detailsContent.parents('section'),
            isFixedNav = !$(document).children().hasClass('ie'),
            navPadding = (isFixedNav ? 50 : 0),
            contentTop = -1;
            
        var calcHeight = function(isFixed) {
            var $scroll = $detailsContent.find('div.scroll');
            if (!$scroll.length) { return; }
            else if (!$detailsContent.is(":visible")) { return; }
            
            if (contentTop < 0) {
                contentTop = $detailsContent.offset().top - 8
            }
            
            var scrollOffset = 
                $scroll.offset().top - $detailsContent.offset().top - 8;

            if (typeof isFixed === 'undefined') {
                isFixed = $detailsContent.hasClass('fixed');
            }
            
            if (isFixed) {
                height = ($window.height() - navPadding);
                var pageBottom = $window.scrollTop() + $window.height();
                var parentBottom = $detailsSection.offset().top + $detailsSection.height();
                if (pageBottom > parentBottom) {
                    height -= (pageBottom - parentBottom);
                }
                else { height -= 40; }
            }
            else {
                height = ($window.height() - (contentTop - $window.scrollTop()) - 40);
            }

            $treeContainer.css({ 'min-height' : (height + 24) + 'px' });
            $scroll.css({ 'max-height' : (height - scrollOffset) + 'px' });
        };
        
        var calcWidth = function() {
            $detailsContent.css({ 'width' : $detailsParent.width() + 'px' });
        }

        calcHeight(); calcWidth();
        $(window).resize(function() { calcHeight(); calcWidth(); });
        
        $(document).scroll(function() {
            if (!$detailsContent.is(":visible")) { return; }
            
            var scrollTop = $window.scrollTop() + navPadding;
            if (contentTop < 0) {
                contentTop = $detailsContent.offset().top - 8
            }

            if (scrollTop < contentTop) {
                calcHeight(false);
                $detailsContent.removeClass('fixed');
            }
            else {
                calcHeight(true);
                $detailsContent.addClass('fixed');
            }
        });
        
        var updateLocation = function(uri) {
            var href = location.href;
            var idx = href.indexOf('#');
            if (idx > 0) { href = href.substring(0, idx); }
            location.href = href + '#' + escape(uri);
        }
        
        var lastUri = null;
        setInterval(function() {
            var $detailsContent = $('#details-content');
            if (!$detailsContent.is(":visible")) { return; }
            
            var href = location.href;
            var idx = href.indexOf('#');
            if (idx > 0) {
                var uri = unescape(href.substring(idx + 1));
                if (lastUri != uri) {
                    lastUri = uri;
                    $detailsContent.load(uri, function() {
                        calcWidth();
                        calcHeight();
                        initTemplateOptionLinks();
                    });
                }
            }
            else {
                if (lastUri != null) {
                    lastUri = null;
                    $detailsContent.html('');
                }
            }
        }, 250);
        
        $treeContainer
            .bind("loaded.jstree", function (event, data) {
                var expandFirst = $('#tree-container').attr('expandFirst');
                if ( expandFirst && expandFirst == "true" ) {
                    var elemId = $('#tree-container ul li').eq(0).attr('id');
                    toggleTreeNode(elemId);
                }
            })
            .jstree({
                "core": { "animation" : 0 },
                "plugins" : [
                    "themes",
                    "html_data",
                    "ui",
                    "types"],
                "themes" : {
	                "theme" : "default",
	                "url" : "styles/style_jstree",
	                "dots" : true,
	                "icons" : true
	            }
        });
        $('#tree-search-text').bind("change keyup", function(evt) {
            var text = $(this).val();
            //$("#tree-container").jstree("search", text);
            if ( text != '' ) {
                filterTreeNodes();
            } else {
                $("#tree-container ul li a.jstree-search").removeClass('jstree-search');
                $("#tree-container ul li").show();
            }
        });
        $('#toggleTree').click( function(evt) {
            toggleTreeNodes();
        });
        $('#expandCollapseTree').click( function(evt) {
            var buttonText = $(this).find('.ui-button-text').text();
            if ( buttonText == 'Expand All' ) {
                expandTreeNodes();
                $(this).find('.ui-button-text').text('Collapse All');
            } else if ( buttonText == 'Collapse All' ) {
                collapseTreeNodes();
                $(this).find('.ui-button-text').text('Expand All');
            }
        });
        $('#showHideTypes').click( function(evt) {
            var buttonText = $(this).find('.ui-button-text').text();
            if ( buttonText == 'Hide Types' ) {
                $('#tree-container li a span.italic').hide();
                $(this).find('.ui-button-text').text('Show Types');
            } else if ( buttonText == 'Show Types' ) {
                $('#tree-container li a span.italic').show();
                $(this).find('.ui-button-text').text('Hide Types');
            }
        });
        var loadLeaf = true;
        $('#tree-container li').click( function (evt) {
            var text = $(this).find("a").eq(0).text();
            var rel = $(this).attr('rel');
            var isRoot = $(this).parents('li').length == 0;

            // load details
            var details = $(this).attr('details');
            if ( details ) {
                if ( loadLeaf ) {
                    updateLocation(details); 
                }
            }
            // must do this because evt.stopPropagation() breaks tree
            if ( isRoot ) {
                loadLeaf = true;
            } else {
                loadLeaf = false;
            }
        });
        $('#tree-container li a').click( function (evt) {
            evt.preventDefault();
        });
        $('#tree-container li').dblclick( function (evt) {
            var rel = $(this).attr('rel');
            if ( rel != 'template' ) {
                var elemId = $(this).attr("id");
                $("#tree-container").jstree("toggle_node", "#"+elemId);
                evt.stopPropagation();
            } else {
                var href = $(this).children('a').eq(0).attr('href');
                if ( href != '#' ) {
                    window.open(href, '_blank');
                }
            }
        });
        $("#details-content a").live('click', function (evt) {
            var href = $(this).attr('href');
            var target = $(this).attr('target');
            if ( !target && href && href != '#' ) {
                updateLocation(href);
                evt.preventDefault();
            }
        });
    };

    /* logs */
    function initLogs () {
        getLogEvents();
        setInterval(getLogEvents, 15000);

        $('#showHideLogs').click( function(evt) {
            var numLast = $('#logs-container ul').eq(0).attr('numLast');
            var buttonText = $(this).find('.ui-button-text').text();
            if ( buttonText == 'Show Last '+numLast ) {
                $(this).find('.ui-button-text').text('Show All');
            } else if ( buttonText == 'Show All' ) {
                $(this).find('.ui-button-text').text('Show Last '+numLast);
            }

            filterLogEvents();
        });
        $('#logs-search-text').bind("change keyup", function(evt) {
            filterLogEvents();
        });
    };
    function filterLogEvents () {
        var showLast = true;
        var buttonText = $('#showHideLogs .ui-button-text').text();
        if ( buttonText != 'Show All' ) {
            showLast = false;
        }

        var regex;
        try {
            var pattern = $('#logs-search-text').val();
            if ( pattern == '' ) {
                return true;
            }
            regex = new RegExp(pattern, 'ig');

            $('#logs-search-text').css('border-color', 'green');
            $("#logs-container ul li").each( function(i, val) {
                var text = $(this).text();
                if ( regex.test(text) ) {
                    $(this).addClass('regexMatch');
                } else {
                    $(this).removeClass('regexMatch');
                }
            });
        } catch(e) {
            $('#logs-search-text').css('border-color', 'red');
        } finally {
            if ( showLast ) {
                var numLast = $('#logs-container ul').eq(0).attr('numLast');
                if ( $('#logs-container li.regexMatch').length > 0 ) {
                    $('#logs-container li').addClass('hide');

                    $('#logs-container li.regexMatch')
                        .slice(-1*parseInt(numLast))
                        .removeClass('hide');

                } else {
                    $('#logs-container li').addClass('hide');

                    $('#logs-container li')
                        .slice(-1*parseInt(numLast))
                        .removeClass('hide');
                }
            } else {
                if ( $('#logs-container li.regexMatch').length > 0 ) {
                    $('#logs-container li').addClass('hide');
                    $('#logs-container li.regexMatch').removeClass('hide');
                } else {
                    $('#logs-container li').removeClass('hide');
                }
            }
        }
    };
    function getLogEvents () {
        var showLast = true;
        var buttonText = $('#showHideLogs .ui-button-text').text();
        if ( buttonText != 'Show All' ) {
            showLast = false;
        }

        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getLogEvents?showLast="+showLast,
            success: function (data) {
                $("#logs-container").html(data);
            },
            complete: function () {
                filterLogEvents();
                $('#loadingIndicator').hide();
            }
        });
    };
    function initJanitorOptions () {
        $('#buttonset-view .ui-button').live('click', function (evt) {
             var text = $(this).text();

             if ( text == "Applications" ) {
                $("#janitor-container-applications").show();
                $("#janitor-container-templates").hide();
             } else if ( text == "Templates" ) {
                $("#janitor-container-templates").show();
                $("#janitor-container-applications").hide();
            }
        });
    };
    function initTemplateViewerOptions () {
        $(window).load(function() {
            if (location.href.indexOf('#line') > 0) {
                document.body.scrollTop -= 50;
            }
        });

        $('#template-viewer .template .call a').live('click', function (evt) {
            var parent = '';
            var href = location.href;
            var idx = href.indexOf('&name=');
            if (idx > 0) {
                var lidx = href.indexOf('&', idx + 6);
                parent = href.substring(idx + 6, lidx > 0 ? lidx : href.length);
                idx = parent.lastIndexOf('.');
                parent = (idx > 0 ? parent.substring(0, idx) : null);
            }
            
            location.href = '?page=viewer&parent=' + parent + '&name=' + $(this).text();
            event.preventDefault();
            return false;
        });
        
        $('#template-viewer .template .function a').live('click', function (evt) {
            location.href = '?page=functions&name=' + $(this).text();
            event.preventDefault();
            return false;
        });
        
        var setupTitles = function(id) {
            $("#" + id + " li").each(function() {
                var $this = $(this);
                if (!$this.attr('title')) {
                    var text = $this.children('a').text();
                    text = text.replace(/\s*[\r\n]+\s*/g, " ").trim();
                    $this.attr('title', text);
                }
            });
        };
        
        setupTitles('callees');
        setupTitles('callers');
        setupTitles('caller-lines');
        
        $('#template-viewer .caller-link').live('click', function (evt) {
            var $this = $(this);
            var timer = setTimeout(function() {
                var href = $this.attr('href');
                var nidx = href.lastIndexOf('&name='), 
                    pidx = href.lastIndexOf('&parent=');
                    
                var id = href.substring(nidx + 6);
                var parent = href.substring(pidx + 8, nidx) 
                $('#caller-lines').slideUp('fast', function() {
                    $('#caller-lines').load('<% pathPrefix %>system/viewer/callerlines?id=' + parent + '&caller=' + id, function() {
                        setupTitles('caller-lines');
                        $('#caller-lines').slideDown('fast');
                    });
                });
                
                $this.data('timer', null);
            }, 250);
            
            $this.data('timer', timer);
            evt.preventDefault();
            return false;
        });
        
        $('#template-viewer .caller-link').live('dblclick', function (evt) {
            var timer = $(this).data('timer');
            if (timer != null) { clearTimeout(timer); }
            
            var href = $(this).attr('href');
            location.href = href;
            evt.preventDefault();
            return false;
        });
        
        initTemplateOptionLinks();
    };
    function initCompileOptions () {
        $("#switch-autocompile").iphoneSwitch(
            "off",
            function() {
                $('#label-validate').fadeOut('fast');
                $('#buttonset-validate').fadeOut('fast');
                $('#label-compile').fadeOut('fast');
                $('#buttonset-compile').fadeOut('fast');

                if (!$("#switch-autorefresh").hasClass('state-on')) {
                    $("#switch-autorefresh").click();
                }
                
                $("#switch-autocompile").removeClass('state-off').addClass('state-on');
                clearInterval(templateInterval);
                templateInterval = setInterval(autocompileTemplates, 5000);
            },
            function() {
                $('#label-validate').fadeIn('fast');
                $('#buttonset-validate').fadeIn('fast');
                $('#label-compile').fadeIn('fast');
                $('#buttonset-compile').fadeIn('fast');

                $("#switch-autocompile").removeClass('state-on').addClass('state-off');
                
                clearInterval(templateInterval);
                var state = $("#switch-autorefresh").hasClass('state-on');
                if (state) {
                    templateInterval = setInterval(getTemplateUpdates, 10000);
                }
			}
		);
		$("#switch-autorefresh").iphoneSwitch(
            "on",
            function() {
                $("#switch-autorefresh").removeClass('state-on').addClass('state-off');
                
                clearInterval(templateInterval);
                var state = $("#switch-autocompile").hasClass('state-on');
                if (state) {
                    templateInterval = setInterval(autocompileTemplates, 5000);
                }
                else {
                    templateInterval = setInterval(getTemplateUpdates, 10000);
                }                
            },
            function() {
                $("#switch-autorefresh").removeClass('state-off').addClass('state-on');
                clearInterval(templateInterval);
            }
        );
        $("#buttonset-validate .ui-button").click( function (evt) {
            $(".controls-wrapper .ui-button").button( "option", "disabled", true );
            $('#loadingIndicator').show();

            var isReady = true;
            var url = 'remote/reload';

            var buttonText = $(this).find('span').text();
            if ( buttonText == 'Selected' ) {
                url += '?testCompile=selected';
                $("#reload-container .reloadableTemplates").each( function(i,val) {
                    if ( $(this).is(":checked") ) {
                        var reloadableTemplate = $(this).attr('name');
                        if ( reloadableTemplate ) {
                            url += '&selectedTemplates=' + reloadableTemplate;
                        }
                    }
                });
                isReady = true;
            } else if ( buttonText == "Changes" ) {
                url += '?testCompile=changes';
            } else if ( buttonText == "All" ) {
                url += '?testCompile=all';
            }

            if ( isReady ) {
                $.ajax({
                    url: url,
                    success: function (data) {
                        $("#reload-container").html(data);
                    },
                    complete: function () {
                        $(".controls-wrapper .ui-button").removeClass('ui-state-active');
                        $(".controls-wrapper .ui-button").button( "option", "disabled", false );
                        $('#loadingIndicator').hide();
                        SyntaxHighlighter.highlight();
                    }
                });
            } else {
                $("#reload-container").html('Feature is not ready yet.');
                $('#loadingIndicator').hide();
            }
        });
        $("#buttonset-compile .ui-button").click( function (evt) {
            $(".controls-wrapper .ui-button").button( "option", "disabled", true );
            $('#loadingIndicator').show();

            var isReady = true;
            var url = 'remote/reload';

            var buttonText = $(this).find('span').text();
            if ( buttonText == 'Selected' ) {
                url += '?reloadTemplates=selected';
                $("#reload-container .reloadableTemplates").each( function(i,val) {
                    if ( $(this).is(":checked") ) {
                        var reloadableTemplate = $(this).attr('name');
                        if ( reloadableTemplate ) {
                            url += '&selectedTemplates=' + reloadableTemplate;
                        }
                    }
                });
                isReady = true;
            } else if ( buttonText == "Changes" ) {
                url += '?reloadTemplates=changes';
            } else if ( buttonText == "All" ) {
                url += '?reloadTemplates=all';
            } else if ( buttonText == "Cluster" ) {
                url += '?reloadTemplates=changes&cluster=true';
            }

            if ( isReady ) {
                $.ajax({
                    url: url,
                    success: function (data) {
                        $("#reload-container").html(data);
                    },
                    complete: function () {
                        $(".controls-wrapper .ui-button").removeClass('ui-state-active');
                        $(".controls-wrapper .ui-button").button( "option", "disabled", false );
                        $('#loadingIndicator').hide();
                        SyntaxHighlighter.highlight();
                    }
                });
            } else {
                $("#reload-container").html('Feature is not ready yet.');
                $('#loadingIndicator').hide();
            }
        });

        $('.sml-w .reloadableTemplates').live('click', function(evt) {
            // cookie test
            if ( $.cookies.test() ) {
                // browser is accepting cookies

                var selectedTemplate = $(this).attr('name');

                var previousTemplatesString = $.cookies.get('selectedTemplates');

                if ( $(this).is(":checked") ) {
                    var newTemplatesArray = new Array(selectedTemplate);
                    if ( previousTemplatesString && previousTemplatesString.length ) {
                        previousTemplatesArray = previousTemplatesString.split(",");
                        newTemplatesArray = $.merge(newTemplatesArray, previousTemplatesArray);
                    }
                    var newTemplatesString = newTemplatesArray.join(",");
                    $.cookies.set('selectedTemplates', newTemplatesString);

                } else {
                    if ( previousTemplatesString && previousTemplatesString.length ) {
                        var previousTemplatesArray = previousTemplatesString.split(",");
                        templateIndex = $.inArray(selectedTemplate, previousTemplatesArray);
                        if ( templateIndex > -1 ) {
                            var newTemplatesArray = previousTemplatesArray;
                            newTemplatesArray.splice(templateIndex, 1);
                            var newTemplatesString = newTemplatesArray.join(",");
                            $.cookies.set('selectedTemplates', newTemplatesString);
                        }
                    }
                }
            }
        });

		$(".table-container a.methodName").live("click", function(evt) {
            var url = 'format/getTemplateDetails?name=' + $(this).attr("template");
			$.ajax({
                url: url,
                success: function (data) {
                    $(data).dialog({
						height: 400,
						width: 600,
						modal: true
					});
                },
				complete : function (data) {
					$('.ui-dialog table a').each( function(i, val) {
						var linkText = $(this).text();
						$(this).replaceWith(linkText);
					});
				}
            });
			evt.preventDefault();
		});
		
		initTemplateOptionLinks();
    };
    function getTemplateUpdates () {
        if ( $('#reload-container .sml-e').length == 0 ) {
            $('#loadingIndicator').show();
            $.ajax({
                url: "remote/reload?findUpdates=true",
                success: function (data) {
                    var result = data;

                    updateCompileHistory();

                    $("#reload-container").html(result);

                    // cookie test
                    if ( $.cookies.test() ) {
                        // browser is accepting cookies
                        var selectedTemplatesString = $.cookies.get('selectedTemplates');
                        if ( selectedTemplatesString && selectedTemplatesString.length ) {
                            var selectedTemplatesArray = selectedTemplatesString.split(',');
                            $(result).find('input').each( function(i,val) {
                                var name = $(val).attr('name');
                                var templateIndex = $.inArray(name, selectedTemplatesArray);
                                if ( templateIndex > -1 ) {
                                    var replaceName = name.replace(/\./g, '_');
                                    $('#template_'+replaceName).attr('checked', 'checked');
                                }
                            });
                        }
                    }
                },
                complete: function () {
                    $('#loadingIndicator').hide();
                    SyntaxHighlighter.highlight();
                    prettyLinks();
                }
            });
        }
    };
    function autocompileTemplates () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "remote/reload?reloadTemplates=changes",
            success: function (data) {
                updateCompileHistory();
                $("#reload-container").html(data);
            },
            complete: function () {
                $('#loadingIndicator').hide();
                SyntaxHighlighter.highlight();
                prettyLinks();
            }
        });
    };
    function updateCompileHistory () {
        if ( $('#reload-container .sml-c, #reload-container .sml-e').length != 0 ) {
            var d = new Date();
            var currentTime = d.getTime();

            var compileHTML = '';
            var errorHTML = '';
            var previousError = '';
            $('#reload-container .sml-cnt li').each( function (i,val1) {
                var newCompile = $(val1);
                $('#reload-container-history .sml-cnt li').each( function (j,val2) {
                    var oldCompile = $(val2);
                    if ( !$(oldCompile).is('.default') ) {
                        var isCorrectOld = $(oldCompile).closest('.sml-s').is('.sml-c');
                        var isCorrectNew = $(newCompile).closest('.sml-s').is('.sml-c');
                        var isErrorOld = $(oldCompile).closest('.sml-s').is('.sml-e');
                        var isErrorNew = $(newCompile).closest('.sml-s').is('.sml-e');

                        if ( (isCorrectOld == isCorrectNew) || (isErrorOld == isErrorNew) ) {
                            if ( $(newCompile).find('a').eq(0).text() == $(oldCompile).find('a').eq(0).text() ) {
                                $(oldCompile).remove();
                            }
                        }
                    }
                });
                if ( $(newCompile).closest('.sml-s').is('.sml-c') ) {
                    compileHTML += '<li timestamp="' + currentTime + '">' + $(newCompile).find('a').parent().html() + '</li>';
                } else if ( $(newCompile).closest('.sml-s').is('.sml-e') ) {
                    if ( previousError != $(newCompile).find('a').text() ) {
                        errorHTML += '<li timestamp="' + currentTime + '">' + $(newCompile).find('a').parent().html() + '</li>';
                        previousError = $(newCompile).find('a').text();
                    }
                }
            });
            if ( compileHTML != '' ) {
                if ( $('#reload-container-history .sml-c li.default').length > 0 ) {
                    $('#reload-container-history .sml-c li.default').remove();
                }
                $('#reload-container-history .sml-c ul').prepend(compileHTML);
            }
            if ( errorHTML != '' ) {
                if ( $('#reload-container-history .sml-e li.default').length > 0 ) {
                    $('#reload-container-history .sml-e li.default').remove();
                }
                $('#reload-container-history .sml-e ul').prepend(errorHTML);
            }

            if ( !$('#reload-container-history').is(":visible") ) {
                $('.table-container').hide();
                $('#reload-container-history-label').show();
                $('#reload-container-history').show();
            }
        }
    };
    function initInstrumentationOptions () {
        $("#buttonset-compile .ui-button").live('click', function (evt) {
            $(".controls-wrapper .ui-button").button( "option", "disabled", true );
            $('#loadingIndicator').show();

            var url = 'remote/reload';

            var buttonText = $(this).find('span').text();
            if ( buttonText == "Changes" ) {
                url += '?reloadTemplates=changes';
            } else if ( buttonText == "All" ) {
                url += '?reloadTemplates=all';
            } else if ( buttonText == "Cluster" ) {
                url += '?reloadTemplates=changes&cluster=true';
            }

            $.ajax({
                url: url,
                success: function (data) {
                    var title = "Compile: " + buttonText;

                    var msg = 'No changes detected';
                    var img = '<% pathPrefix %>system/assets/images/notification-info.png';

                    if ( $(data).closest('.sml-e').length > 0 ) {

                        img = '<% pathPrefix %>system/assets/images/notification-incorrect.png';
                        msg = 'Encountered errors.<br/>[<a href="?page=compile" style="color: red !important; text-decoration: underline;">Try again</a>]';

                    } else if ( $(data).closest('.sml-c').length > 0 ) {

                        img = '<% pathPrefix %>system/assets/images/notification-correct.png';
                        msg = 'Successful';

                    }

                    $.gritter.add({
                        // (string | mandatory) the heading of the notification
                        title: title,
                        // (string | mandatory) the text inside the notification
                        text: msg,
                        // (string | optional) the image to display on the left
                        image: img,
                        // (bool | optional) if you want it to fade out on its own or just sit there
                        sticky: false,
                        // (int | optional) the time you want it to be alive for before fading out
                        time: ''
                    });
                },
                complete: function () {
                    $("#buttonset-compile .ui-button").removeClass('ui-state-active');
					$("#buttonset-compile .ui-button").button( "option", "disabled", false );
					$('#loadingIndicator').hide();
                }
            });
        });
        $("#buttonset-view .ui-button").click( function (evt) {
            $(".controls-wrapper .ui-button").button( "option", "disabled", true );
            var button_view = $(this).attr('id');
            $.bbq.pushState( { 'view' : button_view } );
            getInstrumentationUpdates();
        });
        $(".trend-options a").live("click", function (evt) {
            $(".trend-options a").removeClass('active');
            $(this).addClass('active');

            if ( $(this).is(".duration") || $(this).is(".payload") ) {
                getInstrumentationUpdates();
            }

            evt.preventDefault();
        });
		$(".template-options a").live("click", function (evt) {
	            if ( $(this).is(".web") || $(this).is(".info") ) {
				// follow link
                //evt.preventDefault();
            } else if ( $(this).is(".compile") || $(this).is(".reset") ) {
		        $('#loadingIndicator').show();
				var link = $(this);
				var url = $(link).attr('href');
				var qs = $.deparam.querystring(url);

				$.ajax({
		            url: url,
		            success: function (data) {
						if ( $(link).is(".compile") ) {
							var name = qs.selectedTemplates;
							if ( name.indexOf('.') > -1 ) {
								index = name.lastIndexOf('.');
								name = name.substring(index+1);
							}
							var msg = 'No changes detected.';
							var img = '<% pathPrefix %>system/assets/images/notification-info.png';

							if ( $(data).closest('.sml-e').length > 0 ) {

								img = '<% pathPrefix %>system/assets/images/notification-incorrect.png';
								msg = 'Template contains errors.<br/>[<a href="?page=compile" style="color: red !important; text-decoration: underline;">Try again</a>]';

							} else if ( $(data).closest('.sml-c').length > 0 ) {

								img = '<% pathPrefix %>system/assets/images/notification-correct.png';
								msg = 'Template compiled successfully!';

							}

							$.gritter.add({
								// (string | mandatory) the heading of the notification
								title: name,
								// (string | mandatory) the text inside the notification
								text: msg,
								// (string | optional) the image to display on the left
								image: img,
								// (bool | optional) if you want it to fade out on its own or just sit there
								sticky: false,
								// (int | optional) the time you want it to be alive for before fading out
								time: ''
							});
						} else if ( $(link).is(".reset") ) {
							if ( data == 'Success' ) {
								var name = qs.name;
								if ( name.indexOf('.') > -1 ) {
									index = name.lastIndexOf('.');
									name = name.substring(index+1);
								}
								var msg = 'Template stats were reset.';
								var img = '<% pathPrefix %>system/assets/images/notification-correct.png';

								$.gritter.add({
									// (string | mandatory) the heading of the notification
									title: name,
									// (string | mandatory) the text inside the notification
									text: msg,
									// (string | optional) the image to display on the left
									image: img,
									// (bool | optional) if you want it to fade out on its own or just sit there
									sticky: false,
									// (int | optional) the time you want it to be alive for before fading out
									time: ''
								});
							}
						}
		            },
		            complete: function () {
		                $('#loadingIndicator').hide();
		                
		                if ($("#instrumentation-container").length) {
		                    getInstrumentationUpdates();
		                }
		            }
		        });
				evt.preventDefault();
			}
        });

		var viewState = $.bbq.getState('view');
		if ( viewState ) {
		    $('#'+viewState).trigger('click');
		}
    };
    function initSystemInfoOptions() {

        $('#buttonset-tabs .ui-button').live('click', function (evt) {
            var forId = $(this).attr('for');
            var radio = $('#' + forId);
            var tab = radio.val();
            if (tab) {
                $('div.system-info-tab.ui-active').removeClass('ui-active').fadeOut(200, function() {
                    $('#system-info-' + tab).addClass('ui-active').fadeIn(200);
                });
            }
        });

        $('#buttonset-refresh .ui-button').live('click', function (evt) {
            var forId = $(this).attr('for');
            var radio = $('#' + forId);
            var interval = radio.val();
            if (typeof interval !== 'undefined') {
                interval = parseInt(interval, 10);
                $.system.monitor(interval * 1000);
            }
        });

        $('#buttonset-threads .ui-button').live('click', function (evt) {
            var forId = $(this).attr('for');
            var radio = $('#' + forId);
            var element = radio.val();
            if (element) {
                $('div.thread-container.ui-active').removeClass('ui-active').fadeOut(200, function() {
                    $('#thread-container-' + element).addClass('ui-active').fadeIn(200);
                });
            }
        });

        $(window).resize(function() {
            $('.graph').each(function() {
                var $this = $(this);
                if ($this.is(":visible")) {
                    var plot = $this.data('plot');
                    if (plot) { plot.resize(); }
                }
            });
        });
        
        initGridlapses();
        initSystemInfoData();
        
        var refresh = parseInt($('input[name="refresh"]:checked').val(), 10);
        $.system.monitor(refresh * 1000);
    };
    function initSystemInfoData() {
        $.system = {
            MAX_POINTS : 100,
            
            listeners : [],
            addDataListener : function(listener) {
                $.system.listeners.push(listener);
            },
            
            timer : null,
            refresh : function(callback) {
                $('#loadingIndicator').show();
                $.get('<% pathPrefix %>system/remote/jmx', function(json) {
                    for (var i = 0; i < $.system.listeners.length; i++) {
                        $.system.listeners[i](json);
                    }
                }).complete(function() { 
                    $('#loadingIndicator').hide();
                    callback(); 
                });            
            },
            
            monitor : function(interval) {
                var _handler = null;
                if ($.system.timer) { clearTimeout($.system.timer); }
                if (interval > 0) {
                    (_handler = function() {
                        $.system.timer = setTimeout(function() {
                            $.system.refresh(_handler);
                        }, interval);
                    })();
                }
            },

            formatDuration : function(time, type) {
                var result = '';
                
                var days = (1000.0 * 60.0 * 60.0 * 24.0);
                var value = Math.floor(time / days);
                var time = time % days;
                if (value > 0) { 
                    if (type == 'time') { result += value.toFixed(0) + ':'; }
                    else if (type == 'text') { result += value.toFixed(0) + 'd '; }
                }
        
                var hours = (1000.0 * 60.0 * 60.0);
                value = Math.floor(time / hours);
                time = time % hours;
                if (value > 0) { 
                    if (type == 'time') { result += value.toFixed(0) + ':'; }
                    else if (type == 'text') { result += value.toFixed(0) + 'h '; }
                }
                
                minutes = (1000.0 * 60.0);
                value = Math.floor(time / minutes);
                time = time % minutes;
                if (value > 0) { 
                    if (type == 'time') { result += value.toFixed(0) + ':'; }
                    else if (type == 'text') { result += value.toFixed(0) + 'm '; }
                }
                
                seconds = (1000.0);
                value = Math.floor(time / seconds);
                time = time % seconds;
                if (value > 0) { 
                    if (type == 'time') { result += value.toFixed(0) + '.'; }
                    else if (type == 'text') { result += value.toFixed(0) + 's '; }
                }
                
                if (type == 'time') {
                    result += time.toFixed(0);
                }
                
                if (result.length == 0) {
                    result = time + ' ms';
                }
                
                return result;
            },
    
            initPlot : function($container, data, options) {
                var plot = $.plot($container, data, options);
                $container.data('plot', plot);
        
                var previous = null;
                $container.bind("mouseout", function() {
                    previous = null;
                    $.system.hideTooltip();
                    
                    plot.clearCrosshair();
                    $container.data('plothover', null);
                });
                
                $container.bind("plothover", function(event, pos, item) {
                    var axes = plot.getAxes();
                    if (pos.x < axes.xaxis.min || pos.x > axes.xaxis.max ||
                        pos.y < axes.yaxis.min || pos.y > axes.yaxis.max) {
                        return;
                    }
            
                    var contents = '';
                    var datapoint = null;
                    var i, j, dataset = plot.getData();
                    for (i = 0; i < dataset.length; i++) {
                        var series = dataset[i];
            
                        // find the nearest points, x-wise
                        for (j = 0; j < series.data.length; j++) {
                            if (series.data[j][0] > pos.x) {
                                break;
                            }
                        }
                        
                        // now interpolate
                        var p, p1 = series.data[j - 1], 
                               p2 = series.data[j];
        
                        if (p1 == null && p2 == null) { p = null; }
                        else if (p1 == null) { p = p2[1]; }
                        else if (p2 == null) { p = p1[1]; }
                        else if (Math.abs(p1[0] - pos.x) < 
                                 Math.abs(p2[0] - pos.x)) {
                            p = p1;
                        }
                        else { p = p2; }
                        
                        datapoint = p;
                        if (p != null) {
                            if (contents.length == 0) {
                                contents += axes.xaxis.tickFormatter(p[0], axes.xaxis) + '<br /><br />';
                            }
                            
                            contents += series.label + ": " + axes.yaxis.tickFormatter(p[1], axes.yaxis) + '<br />';
                        }
                    }
                    
                    if (datapoint != null) {
                        var poffset = $container.offset();
                        var offset = plot.pointOffset({ x: datapoint[0], y: 0 });
                        
                        $container.data('plothover', [ pos, item ]);
                        $.system.showTooltip(poffset.left + offset.left, pos.pageY, contents, $container);
                        plot.lockCrosshair({ x: datapoint[0] });
                    }
                });
            },
    
            initChart : function($container, type, formatter, callback) {
                var options = {
                    series: {
                        bars: { show: (type == 'bar'), fill: true },
                        lines: { show: (type == 'line'), fill: false },
                        points: { show: false }
                    },
                    grid: {
                        hoverable: true,
                        clickable: true,
                        autoHighlight: false
                    },
                    legend: { show: false },
                    crosshair: { mode: "x" },
                    xaxis: { 
                        show: true, 
                        mode: (type == 'line' ? 'time' : ''),
                        twelveHourClock: true 
                    },
                    yaxis: { 
                        show: true, 
                        min: 0, 
                        tickFormatter: formatter 
                    },
                };
                
                if (callback) {
                    callback(options);
                }
        
                var data = [ ], handlers = [ ];
                for (var i = 4; i < arguments.length; i += 2) {
                    handlers.push(arguments[i + 1]);
                    
                    var series = null;
                    if (typeof arguments[i] == 'object') {
                        series = arguments[i];
                        series.data = [];
                    }
                    else {
                        series = { label: arguments[i], data: [] };
                    }
                    
                    data.push(series);
                }
        
                $container.data('plot', null);
                $container.data('plotdata', data);
                $container.data('plothandlers', handlers);
                $container.data('plotoptions', options);
                $container.addClass('graph');
            },

            hideTooltip : function() {
                $('#tooltip').fadeOut(200);
            },
    
            showTooltip : function(x, y, contents, container) {
                var $tooltip = $('#tooltip');
                if ($tooltip.length == 0) {
                    $tooltip = 
                        $('<div id="tooltip"></div>')
                            .css({
                                position: 'absolute',
                                display: 'none',
                                border: '1px solid #fdd',
                                padding: '5px',
                                'background-color': '#000',
                                color: '#FFF',
                                opacity: 0.80,
                                'z-index': 9999,
                                'font-size': '12px',
                                'border-radius': '3px'
                            }
                        ).appendTo("body");
                        
                    $tooltip.css({visibility: 'hidden'})
                        .html(contents);
                }
                else {
                    $tooltip.html(contents);
                }
        
                var left = x, top = y,
                    coffset = container.offset(),
                    cwidth = container.width(), 
                    cheight = container.height(),
                    twidth = $tooltip.width(),
                    theight = $tooltip.height();
                    
                // to the right first
                if (left + twidth + 15 < coffset.left + cwidth) {
                    left = left + 15;
                }
                
                // to the left last
                else { left = left - twidth - 15; }
        
                // to above first
                if (top - theight - 15 > coffset.top) {
                    top = top - theight - 15;
                }
                
                // to bottom last
                else { top = top + 15; }
        
                $tooltip.html(contents)
                        .css({'left': left + 'px', top: top + 'px', visibility: 'visible' })
                        .fadeIn(200);
            }
        };

        initSystemInfoDataGeneral();
        initSystemInfoDataOverview();
        initSystemInfoDataMemory();  
        initSystemInfoDataThreads();
        initSystemInfoDataMBeans();
        initSystemInfoDataInfo();
    };
    function initSystemInfoDataGeneral() {
        $.system.addDataListener(function(json) {
            var usedHeapMemory = json.memory.heap.used / 1024 / 1024;
            var maxHeapMemory = json.memory.heap.max / 1024 / 1024;
            var freeHeapMemory = maxHeapMemory - usedHeapMemory;
            $('#freeHeapMemory .value .number').text(freeHeapMemory.toFixed(0));
            $('#usedHeapMemory .value .number').text(usedHeapMemory.toFixed(0));
            $('#totalHeapMemory .value .number').text(maxHeapMemory.toFixed(0));
        
            var usedNonHeapMemory = json.memory.nonheap.used / 1024 / 1024;
            var maxNonHeapMemory = json.memory.nonheap.max / 1024 / 1024;
            var freeNonHeapMemory = maxNonHeapMemory - usedNonHeapMemory;
            $('#freeNonHeapMemory .value .number').text(freeNonHeapMemory.toFixed(0));
            $('#usedNonHeapMemory .value .number').text(usedNonHeapMemory.toFixed(0));
            $('#totalNonHeapMemory .value .number').text(maxNonHeapMemory.toFixed(0));
        });
        
        $.system.addDataListener(function(json) {
            $('.graph').each(function(idx) {
                var $this = $(this),
                    plot = $this.data('plot'),
                    data = $this.data('plotdata'),
                    handlers = $this.data('plothandlers'),
                    options = $this.data('plotoptions');
                
                for (var i = 0; i < handlers.length; i++) {
                    var point = handlers[i](json);
                    if (point === null) { continue; }
                    
                    if (!$.isArray(point)) {
                        point = [ json.timestamp, point ];
                    }
                    
                    if ($.isArray(point[0])) {
                        for (var j = 0; j < point.length; j++) {
                            data[i].data.push(point[j]);
                        }
                    }
                    else {
                        if (options.series.bars.show) {
                            data[i].data = [ point ];
                        }
                        else {
                            data[i].data.push(point);
                        }
                    }
                    
                    if (data[i].data.length > $.system.MAX_POINTS) {
                        // TODO: aggregate data over time period
                        data[i].data.shift();
                    }
                }
                
                if (!plot) {
                    if (!$this.is(':visible')) { return; }
                    plot = $.system.initPlot($this, data, options);
                }
                else {
                    plot.setData(data);
                    if ($this.is(':visible')) {
                        plot.resize();
                    }
                    
                    plot.setupGrid();
                    plot.draw();
                    plot.clearCrosshair();
                }
                
                var plothover = $this.data('plothover');
                if (plothover) {
                    $this.trigger('plothover', plothover[0], plothover[1]);
                }
            });
        });
    };
    function initSystemInfoDataOverview() {
        var prevUptime = -1, prevCputime = -1, 
            calculateCpu = function(json) {
                if (typeof json.os.cpu !== 'undefined') { return json.os.cpu; }
                if (typeof json.os.processtime === 'undefined') { return 0; }
                
                var procs = json.os.processors;
                var uptime = json.runtime.uptime;
                var cputime = json.os.processtime;
                if (prevUptime > 0 && prevCputime > 0) {
                    var elapsedTime = uptime - prevUptime;
                    var elapsedCpu = cputime - prevCputime;
                    // CPU usage could go higher than 100% because elapsedTime
                    // and elapsedCpu are not fetched simultaneously so limit
                    // to 100
                    json.os.cpu = Math.min(100.0, (elapsedCpu / (elapsedTime * procs) * 100.0));
                }
                else {
                    json.os.cpu = 0;
                }
                
                prevUptime = uptime;
                prevCputime = cputime;
                return json.os.cpu;
            };
        
        $.system.addDataListener(function(json) {
            $('#uptime').text($.system.formatDuration(json.runtime.uptime, 'text'));
            
            if (typeof json.os.processtime !== 'undefined') {
                $('#processtime').text($.system.formatDuration(json.os.processtime, 'text'));
            }
            
            $('#cpu-used').text(calculateCpu(json).toFixed(1) + '%');
            
            $('#heap-memory-used').text((json.memory.heap.used / 1024.0 / 1024.0).toFixed(1));
            $('#heap-memory-committed').text((json.memory.heap.committed / 1024.0 / 1024.0).toFixed(1));
            $('#heap-memory-max').text((json.memory.heap.max / 1024.0 / 1024.0).toFixed(1));
            
            //$('#oldgen-memory-used').text((json.pools.tenured.usage.used / 1024.0 / 1024.0).toFixed(1));
            //$('#oldgen-memory-committed').text((json.pools.tenured.usage.committed / 1024.0 / 1024.0).toFixed(1));
            //$('#oldgen-memory-max').text((json.pools.tenured.usage.max / 1024.0 / 1024.0).toFixed(1));
            //$('#oldgen-memory-peak').text((json.pools.tenured.peak.used / 1024.0 / 1024.0).toFixed(1));
            
            $('#classes-loaded').text(json.classes.loaded);
            $('#classes-unloaded').text(json.classes.unloaded);
            
            $('#threads-live').text(json.threads.count);
            $('#threads-peak').text(json.threads.peak);
            $('#threads-daemon').text(json.threads.daemon);
            $('#threads-started').text(json.threads.total);
        });
            
        $.system.initChart(
            $('#cpu-usage'), 
            'line',
            function(y) {
                return y.toFixed(1) + '%';
            },
            function(options) {
                options.legend.show = true;
                options.legend.position = 'nw';
                options.yaxis.min = 0;
                options.yaxis.max = 100;
            },
            
            'CPU Usage', 
            function(data) { 
                return calculateCpu(data);
            }
        );
        
        $.system.initChart(
            $('#heap-usage'), 
            'line',
            function(y) {
                return (y / 1024 / 1024).toFixed(1) + ' MB';
            },
            function(options) {
                options.legend.show = true;
                options.legend.position = 'nw';
                options.series.stack = true;
                options.series.lines.fill = true;
            },
            
            'Heap Used', 
            function(data) { return data.memory.heap.used; },
            //function(data) { return data.pools.tenured.usage.used; },
            
            'Heap Size',
            function(data) { return data.memory.heap.committed; }
            //function(data) { return data.pools.tenured.usage.committed; }
        );
    
        $.system.initChart(
            $('#class-usage'),
            'line', 
            function(y) { return y.toFixed(0); },
            function(options) {
                options.legend.show = true;
                options.legend.position = 'nw';
            },
            
            'Total Loaded Classes', 
            function(data) {
                return data.classes.loaded;
            }
        );
        
        $.system.initChart(
            $('#thread-usage'),
            'line', 
            function(y) { return y.toFixed(0); },
            function(options) {
                options.legend.show = true;
                options.legend.position = 'nw';
            },
            
            'Live Threads', 
            function(data) { return data.threads.count; },
            
            'Daemon Threads', 
            function(data) { return data.threads.daemon; }
        );
    };
    function initSystemInfoDataMemory() {
        function initSpaces() {
            $.system.initChart(
                $('#memory-spaces'), 
                'bar',
                function(y) {
                    return (y / 1024 / 1024).toFixed(1) + ' MB';
                },
                function(options) {
                    options.series.stack = true;
                    options.xaxis.ticks = [
                        [ 1, 'Perm Gen' ],
                        [ 3, 'Old Gen' ],
                        [ 5, 'Eden' ]
                    ];
                },
                
                { label: 'Perm Gen Used', color: 0 }, 
                function(data) { return [ 1, data.pools.perm.usage.used ]; },
                
                { label: 'Perm Gen Committed', color: '#e0e0e0' },
                function(data) { return [ 1, data.pools.perm.usage.committed ]; },
                
                { label: 'Perm Gen Committed', color: '#eeeeee' },
                function(data) { return [ 1, data.pools.perm.usage.max ]; },
                
                { label: 'Old Gen Used', color: 0 }, 
                function(data) { return [ 3, data.pools.tenured.usage.used ]; },
                
                { label: 'Old Gen Committed', color: '#e0e0e0' },
                function(data) { return [ 3, data.pools.tenured.usage.committed ]; },
                
                { label: 'Old Gen Size', color: '#eeeeee' },
                function(data) { return [ 3, data.pools.tenured.usage.max ]; },
                
                { label: 'Eden Used', color: 0 }, 
                function(data) { return [ 5, data.pools.eden.usage.used ]; },
                
                { label: 'Eden Committed', color: '#e0e0e0' },
                function(data) { return [ 5, data.pools.eden.usage.committed ]; }
            );
        }
        
        function initCollector(id, property) {
            var $container = $('#' + id);
            $.system.initChart(
                $container,
                'line', 
                function(y) {
                    return (y / 1024 / 1024).toFixed(1) + ' MB';
                },
                function(options) {
                    options.yaxis.labelWidth = 60;
                    options.series.lines.fill = true;
                },
                
                'Collection', 
                function(data) {
                    var last = $container.data('lastGC');
                    var current = data.collectors[property].lastGC;
                    if (current.start < 0) { return 0; }
                    
                    if (!last || last.start != current.start) {
                        $container.data('lastGC', current);
                        return [
                            [ data.runtime.start + current.start - 1, 0 ],
                            [ data.runtime.start + current.start, current.memory.total ],
                            [ data.runtime.start + current.end, current.memory.total ],
                            [ data.runtime.start + current.end + 1, 0 ]
                        ];
                    }
                    
                    return 0;
                }
            );
        }
        
        function initUsage(id, property) {
            $.system.initChart(
                $('#' + id), 
                'line',
                function(y) {
                    return (y / 1024 / 1024).toFixed(1) + ' MB';
                },
                function(options) {
                    options.yaxis.labelWidth = 60;
                },
                
                'Used', 
                function(data) { return data.pools[property].usage.used; }
            );
        }
        
        initSpaces();

        initCollector('young-collector', 'young');
        initCollector('tenured-collector', 'tenured');
        
        initUsage('eden-usage', 'eden');
        initUsage('survivor-usage', 'survivor');
        initUsage('oldgen-usage', 'tenured');
        
        $.system.addDataListener(function(json) {
            $('#young-collector-count').text(json.collectors.young.count);
            $('#young-collector-time').text($.system.formatDuration(json.collectors.young.time, 'text'));
            if (json.collectors.young.lastGC.start > 0) {
                var offset = json.timestamp - (json.collectors.young.lastGC.start + json.runtime.start);
                $('#young-collector-lastgc').text($.system.formatDuration(offset, 'text') + ' ago taking ' + $.system.formatDuration(json.collectors.young.lastGC.duration, 'text'));
            }
            
            $('#tenured-collector-count').text(json.collectors.tenured.count);
            $('#tenured-collector-time').text($.system.formatDuration(json.collectors.tenured.time, 'text'));
            if (json.collectors.tenured.lastGC.start > 0) {
                var offset = json.timestamp - (json.collectors.tenured.lastGC.start + json.runtime.start);
                $('#tenured-collector-lastgc').text($.system.formatDuration(offset, 'text') + ' ago taking ' + $.system.formatDuration(json.collectors.tenured.lastGC.duration, 'text'));
            }
            
            $('#eden-memory-used').text((json.pools.eden.usage.used / 1024.0 / 1024.0).toFixed(1));
            $('#eden-memory-committed').text((json.pools.eden.usage.committed / 1024.0 / 1024.0).toFixed(1));
            $('#eden-memory-max').text((json.pools.eden.usage.max / 1024.0 / 1024.0).toFixed(1));
            $('#eden-memory-peak').text((json.pools.eden.peak.used / 1024.0 / 1024.0).toFixed(1));
            
            $('#survivor-memory-used').text((json.pools.survivor.usage.used / 1024.0 / 1024.0).toFixed(1));
            $('#survivor-memory-committed').text((json.pools.survivor.usage.committed / 1024.0 / 1024.0).toFixed(1));
            $('#survivor-memory-max').text((json.pools.survivor.usage.max / 1024.0 / 1024.0).toFixed(1));
            $('#survivor-memory-peak').text((json.pools.survivor.peak.used / 1024.0 / 1024.0).toFixed(1));
            
            $('#oldgen-memory-used').text((json.pools.tenured.usage.used / 1024.0 / 1024.0).toFixed(1));
            $('#oldgen-memory-committed').text((json.pools.tenured.usage.committed / 1024.0 / 1024.0).toFixed(1));
            $('#oldgen-memory-max').text((json.pools.tenured.usage.max / 1024.0 / 1024.0).toFixed(1));
            $('#oldgen-memory-peak').text((json.pools.tenured.peak.used / 1024.0 / 1024.0).toFixed(1));
        });
    };  
    function initSystemInfoDataThreads() {
        var MAX_METRICS = 120, 
            MAX_DIFFERENTIAL = 5000,
            THREAD_STATES = [
                { color: 'black',   label: 'New Thread' },
                { color: 'green',   label: 'Running' },
                { color: 'red',     label: 'Blocked' },
                { color: 'yellow',  label: 'Waiting' },
                { color: 'yellow',  label: 'Timed Waiting' },
                { color: 'black',   label: 'Terminated' }
            ];
        
        var lastTimestamp = -1,
            $grid = $('.grid'),
            $gridnav = $('.grid-lhn'), 
            $headers = $grid.find('.header');
            $rows = $grid.find('.row'),
            $table = $('#thread-container-perf table');

        $.system.addDataListener(function(json) {
            for (var i = 0; i < json.threads.threads.length; i++) {
                var thread = json.threads.threads[i];
                if (!thread || thread.id < 0) { continue; }
                
                var $perf = $('#thread-perf-' + thread.id);
                if ($perf.length == 0) {
                    var count = $table.children('tbody').children('tr').length + 1;
                    var $row = $('' +
                        '<tr id="thread-perf-' + thread.id + '" class="' + (count % 2 == 0 ? 'evenrow' : 'oddrow') + '">' +
                            '<td><a class="thread-details-link" href="<% pathPrefix %>/system/format/getThreadDetails?id=' + thread.id + '" title="' + thread.name + '">' + thread.name + '</a></td>' +
                            '<td class="cpu-time"></td>' +
                            '<td class="blocked-time"></td>' +
                            '<td class="waited-time"></td>' +
                            '<td class="total-time"></td>' +
                        '</tr>');                    
                    
                    $table.children('tbody').append($row);
                    $perf = $('#thread-perf-' + thread.id);
                    $perf.effect('pulsate');
                }
                
                if ($perf.length == 1) {
                    var totalTime = 
                        thread.time.cpu + thread.blocked.time + 
                        thread.waited.time;
                    
                    $perf.find('td.cpu-time')
                        .attr('title', $.system.formatDuration(thread.time.user, 'time') + ' in user mode')
                        .text($.system.formatDuration(thread.time.cpu, 'time'));
                        
                    $perf.find('td.waited-time')
                        .attr('title', 'Waited ' + thread.waited.count + ' times')
                        .text($.system.formatDuration(thread.waited.time, 'time'));
                        
                    $perf.find('td.blocked-time')
                        .attr('title', 'Blocked ' + thread.blocked.count + ' times')
                        .text($.system.formatDuration(thread.blocked.time, 'time'))
                        
                    $perf.find('td.total-time')
                        .text($.system.formatDuration(totalTime, 'time'))
                }
            }
        });
                    
        $.system.addDataListener(function(json) {
            // calculate time differential and insert break if outstanding
            var timestamp = json.timestamp;
            if (lastTimestamp > 0 &&
                timestamp - lastTimestamp > MAX_DIFFERENTIAL) {
                
                insertBreak();
            }
            
            // insert regular metrics per thread
            insertMetrics(json);
            lastTimestamp = timestamp;
            
            // remove old metrics
            purgeMetrics();
        });
        
        function purgeMetrics() {
            $headers.each(function() {
                var $header = $(this),
                    $metrics = $header.children('.metric');
                    
                if ($metrics.length > MAX_METRICS) {
                    $($metrics[$metrics.length - 1]).remove();
                }
            });
            
            $rows.each(function() {
                var $row = $(this),
                    $metrics = $row.children('.metric');
                    
                if ($metrics.length > MAX_METRICS) {
                    $($metrics[$metrics.length - 1]).remove();
                }
            });
        }
        
        function insertBreak() {
            var rowWidth = -1;
            $headers.each(function() {
                var $header = $(this);
                if (rowWidth < 0) {
                    var $metrics = $header.children('.metric');
                    var twidth = ($metrics.length + 1) * 106;
                    rowWidth = Math.max($grid.width(), twidth);
                }
                
                $header.css('width', rowWidth + 'px');

                var $metric = $('<div class="metric" style="text-align: center;"> --- </div>');
                $header.prepend($metric);
            });
            
            // move previous metrics in each row
            $rows.each(function() {
                var $row = $(this), width = $row.width();
                $row.css('width', rowWidth + 'px');
                
                var $metric = $('<div class="metric process transparent"><span class="value">&nbsp;</span></div>'); 
                $row.prepend($metric);
            });
        }
        
        function insertRow(thread) {
            // calculate style
            var count = $rows.length + 1;
            
            // append header if necessary
            if ((count - 1) % 10 == 0) {
                $placeholder = $('.grid-lhn .placeholder');
                $placeholder.before($($gridnav.find('div.header.stathead')[0]).clone());
                
                var $scrollbar = $grid.find('div.scrollbar.last');
                $scrollbar.before($($grid.find('div.header.stathead')[0]).clone());
                $scrollbar.before($($grid.find('div.scrollbar')[0]).clone());
                
                $grid.data('gridlapse').initialize();
            }
            
            // append label
            var clazz = (count % 2 == 0 ? 'evenrow' : 'oddrow');
            var $label = $('' +
                '<div class="row stathead ' + clazz + '">' +
                    '<div class="template" title="">' +
                        '<a class="thread-details-link" href="<% pathPrefix %>/system/format/getThreadDetails?id=' + thread.id + '" title="' + thread.name + '">' +
                            thread.name +
                        '</a>' +
                    '</div>' +
                '</div>');
                
            $('.grid-lhn .placeholder').before($label);

            // append row
            var $row = $('<div id="row-' + thread.id + '" class="row ' + clazz + '"></div>');
            $grid.find('.scrollbar.last').before($row);

            var state = THREAD_STATES[0], 
                label = state.label, color = state.color;
                
            var $metric = $('<div title="' + label + '" class="metric process ' + color + '"><span class="value">&nbsp;</span></div>'); 
            $row.prepend($metric);
            
            // show effect
            $row.effect('pulsate');
            
            // recalc
            $headers = $grid.find('.header');
            $rows = $grid.find('.row')
        }
        
        function insertMetrics(json) {
            var time = json.time;
                    
            // insert time frame into each header
            var rowWidth = -1;
            $headers.each(function() {
                var $header = $(this);
                if (rowWidth < 0) {
                    var $metrics = $header.children('.metric');
                    var twidth = ($metrics.length + 1) * 106;
                    rowWidth = Math.max($grid.width(), twidth);
                }
                
                $header.css('width', rowWidth + 'px');

                var $metric = $('<div class="metric" style="left: -75px; width: 0px;">' + time + '</div>');
                $header.prepend($metric);
                $metric.animate({'left' : '0px', 'width' : '75px' });
            });
            
            // move previous metrics in each row
            $rows.each(function() {
                var $row = $(this), width = $row.width();
                $row.css('width', rowWidth + 'px');
            });

            // reinitialize the grid and scrollbars
            var gridlapse = $grid.data('gridlapse');
            gridlapse.initialize();
            
            // insert row per thread
            for (var i = 0; i < json.threads.threads.length; i++) {
                var thread = json.threads.threads[i];
                if (!thread || thread.id < 0) { continue; }
                
                var $row = $('#row-' + thread.id);
                if ($row.length == 0) {
                    insertRow(thread);
                    $row = $('#row-' + thread.id);
                }
                
                if ($row.length > 0) {
                    var state = THREAD_STATES[thread.state],
                        label = state.label,
                        clazz = 'metric process ' + state.color;
                    
                    var $metric = $('<div title="' + label + '" class="' + clazz + '" style="width: 0px;"><span class="value">&nbsp;</span></div>'); 
                    $row.data('threading', time).prepend($metric);
                    $metric.animate({ 'width' : '78px' });
                }
            }
            
            // cancel threads no longer valid
            $rows.each(function() {
                var $row = $(this);
                var threading = $row.data('threading');
                if (threading == time) { return; }
                else if (threading == 0) {
                    var $metric = $('<div class="metric process transparent" style="width: 0px;"><span class="value">&nbsp;</span></div>'); 
                    $row.prepend($metric);
                    $metric.animate({ 'width' : '78px' });
                }
                else { 
                    var state = THREAD_STATES[5], 
                        label = state.label, color = state.color;
                        
                    var $metric = $('<div title="' + label + '" class="metric process ' + color + '" style="width: 0px;"><span class="value">&nbsp;</span></div>'); 
                    $row.data('threading', 0).prepend($metric);
                    $metric.animate({ 'width' : '78px' });
                }
            });
        }
        
        $('a.thread-details-link').click(function(event) {
            var $this = $(this),
                $dialog = $('#thread-details-dialog');
                
            $dialog.load($this.attr('href'), function() {
                $dialog.attr('title', $this.text());
                $dialog.dialog({ 
                    modal: true, 
                    width: 700, height: 400, 
                    show: { effect: 'drop', direction: "up" }, 
                    buttons: { 
                        'Refresh' : function() { 
                            $dialog.fadeOut('fast');
                            $dialog.load($this.attr('href'), function() {
                                $dialog.fadeIn('fast');
                            });
                        }, 
                        'Close' : function() { $(this).dialog("close"); } 
                    }
                });
            });
              
            event.preventDefault();
            return false;
        });
    };
    function initSystemInfoDataMBeans() {
        // nothing to do
    };
    function initSystemInfoDataInfo() {
        $('#button-refresh a').click(function(event) {
            var $snapshot = $('#system-info-snapshot');
            $snapshot.load($(this).attr('href') + ' #system-info-snapshot');
            
            event.preventDefault();
            return false;
        }); 
    };
    function initTemplateOptionLinks () {
        $(".template-options a").live("click", function (evt) {
            var $this = $(this);
            if ( $this.is(".web") || $this.is(".info") || $this.is(".code") ) {
                // follow link
                // evt.preventDefault();
            } else if ( $this.is(".compile") || $this.is(".reset") ) {
                $('#loadingIndicator').show();
                var link = $this;
                var url = $(link).attr('href');
                var qs = $.deparam.querystring(url);

                $.ajax({
                    url: url,
                    success: function (data) {
                        if ( $(link).is(".compile") ) {
                            var name = qs.selectedTemplates;
                            if ( name.indexOf('.') > -1 ) {
                                index = name.lastIndexOf('.');
                                name = name.substring(index+1);
                            }
                            var msg = 'No changes detected.';
                            var img = '<% pathPrefix %>system/assets/images/notification-info.png';

                            if ( $(data).closest('.sml-e').length > 0 ) {

                                img = '<% pathPrefix %>system/assets/images/notification-incorrect.png';
                                msg = 'Template contains errors.<br/>[<a href="?page=compile" style="color: red !important; text-decoration: underline;">Try again</a>]';

                            } else if ( $(data).closest('.sml-c').length > 0 ) {

                                img = '<% pathPrefix %>system/assets/images/notification-correct.png';
                                msg = 'Template compiled successfully!';

                            }

                            $.gritter.add({
                                // (string | mandatory) the heading of the notification
                                title: name,
                                // (string | mandatory) the text inside the notification
                                text: msg,
                                // (string | optional) the image to display on the left
                                image: img,
                                // (bool | optional) if you want it to fade out on its own or just sit there
                                sticky: false,
                                // (int | optional) the time you want it to be alive for before fading out
                                time: ''
                            });
                        } else if ( $(link).is(".reset") ) {
                            if ( data == 'Success' ) {
                                var name = qs.name;
                                if ( name.indexOf('.') > -1 ) {
                                    index = name.lastIndexOf('.');
                                    name = name.substring(index+1);
                                }
                                var msg = 'Template stats were reset.';
                                var img = '<% pathPrefix %>system/assets/images/notification-correct.png';

                                $.gritter.add({
                                    // (string | mandatory) the heading of the notification
                                    title: name,
                                    // (string | mandatory) the text inside the notification
                                    text: msg,
                                    // (string | optional) the image to display on the left
                                    image: img,
                                    // (bool | optional) if you want it to fade out on its own or just sit there
                                    sticky: false,
                                    // (int | optional) the time you want it to be alive for before fading out
                                    time: ''
                                });
                            }
                        }
                    },
                    complete: function () {
                        $('#loadingIndicator').hide();
                        if (getInstrumentationUpdates) {
                            getInstrumentationUpdates();
                        }
                    }
                });
                evt.preventDefault();
            }
        });
    };
	function initTemplateInfoOptions () {
        initTemplateOptionLinks();

		var viewState = $.bbq.getState('view');
		if ( viewState ) {
		    $('#'+viewState).trigger('click');
		}

		$("#template-info-functions .methodName a").live("click", function(evt) {
            var url = $(this).attr("href");
			$.ajax({
                url: url,
                success: function (data) {
                    $(data).dialog({
						//height: 400,
						width: 600,
						modal: true
					});
                },
				complete : function (data) {
					$('.ui-dialog table a').each( function(i, val) {
						var linkText = $(this).text();
						//$(this).replaceWith(linkText);
					});
				}
            });
			evt.preventDefault();
		});

		$(".ui-dialog .table-container .tablehead a").live("click", function(evt) {
            var url = $(this).attr("href");
			$.ajax({
                url: url,
                success: function (data) {
                    $('.ui-dialog').remove();
                    $(data).dialog({
						//height: 400,
						width: 600,
						modal: true
					});
                },
				complete : function (data) {
					$('.ui-dialog table a').each( function(i, val) {
						var linkText = $(this).text();
						//$(this).replaceWith(linkText);
					});
				}
            });
			evt.preventDefault();
		});
	};
	function initTimelapseOptions () {
	   initGridlapses();
	   initTemplateOptionLinks();
	};
    function initGridlapses() {
        var $gridlapse = $('.gridlapse');
        $gridlapse.each(function() {
            initGridlapse($(this));
        });
    };
	function initGridlapse($gridlapse) {
        var position = { top: 0, left: 0 },
            dragging = null,
            $document = $(document),
            $body = $('body'),
            $grid = $gridlapse.find('.grid'),
            $gridLHN = $gridlapse.find('.grid-lhn'),
            $scrollbars = $gridlapse.find('.scrollbar'),
            $scrollers = $gridlapse.find('.scrollbar .scroller'),
            $tracker = $gridlapse.find('.grid-tracker'),
            $timers = $gridlapse.find('.timer'),
            $container = $gridlapse.find('.grid-container');

        // setup container
        var initialize = function() {
            // re-init vars
            $grid = $gridlapse.find('.grid');
            $gridLHN = $gridlapse.find('.grid-lhn');
            $scrollbars = $gridlapse.find('.scrollbar');
            $scrollers = $gridlapse.find('.scrollbar .scroller');
            $tracker = $gridlapse.find('.grid-tracker');
            $timers = $gridlapse.find('.timer');
            $container = $gridlapse.find('.grid-container');
            
            // initialize grid and scrollbars
            $grid.css('width', $container.width() - $gridLHN.width() - 5);
            $scrollbars.css('width', $grid.width() + 'px');
            $scrollers.css('width', (Math.pow($grid.width(), 2) / $grid[0].scrollWidth) + 'px');
            $grid.scroll(function() {
                $scrollbars.css('left', this.scrollLeft + 'px');
                $scrollers.css('left', (this.scrollLeft / this.scrollWidth * 100.0) + '%');
            });
            
            // initialize tracker and times
            $tracker.appendTo($('body'))
                .css({ 
                    height : ($grid.height() - 48) + 'px',
                    top : ($grid.offset().top + 24) + 'px',
                    left : $grid.offset().left + 'px' 
                });
         
            $timers.appendTo($('body')).each(function(idx) {
                var $header = $('#header-' + (idx + 1));
                $(this).css({
                    top : ($header.offset().top + 1) + 'px'
                });
            });
        };
        
        // setup click to scroll
        
        var scrolling = null;
        var scrollPage = function() {
            if (!scrolling) { return false; }
            
            var scrollbarLeft = scrolling.scrollbar.offset().left,
                scrollerLeft = scrolling.scroller.offset().left,
                scrollbarWidth = scrolling.scrollbar.width(),
                scrollerWidth = scrolling.scroller.width();
            
            if (position.left > scrollbarLeft && 
                position.left < (scrollbarLeft + scrollbarWidth)) {

                if (position.left < scrollerLeft) {
                    var scrollSize = $grid[0].scrollWidth / $grid.width();
                    var scrollX = scrollerWidth * scrollSize;
                    
                    if (position.left > (scrollerLeft - scrollerWidth)) {
                        scrollX = (scrollerLeft - (position.left - (scrollerWidth / 2))) * scrollSize;
                    }
                    
                    var scrollLeft = $grid[0].scrollLeft - scrollX;
                    $grid[0].scrollLeft = scrollLeft;
                }
                else if (position.left > (scrollerLeft + scrollerWidth)) {
                    var scrollSize = $grid[0].scrollWidth / $grid.width();
                    var scrollX = scrollerWidth * scrollSize;
                    
                    if (position.left < (scrollerLeft + (scrollerWidth * 2))) {
                        scrollX = ((position.left - (scrollerWidth / 2)) - scrollerLeft) * scrollSize;
                    }
                    
                    var scrollLeft = $grid[0].scrollLeft + scrollX;
                    $grid[0].scrollLeft = scrollLeft;
                }                        
            } 
        };
        
        // setup scrollbars
       
        $scrollbars
            .live('mouseover', function(event) {
                $timers.hide();
                $tracker.hide();
            })
            .live('mousedown', function(event) {
                var offset = event.offsetX,
                    $scrollbar = $(this),
                    $scroller = $scrollbar.children('.scroller'),
                    scroll = $scroller.position().left,
                    width = $scroller.width(),
                    direction = null;
                     
                if (offset < scroll) {
                    direction = 'left';
                }
                else if (offset > scroll + width) {
                    direction = 'right';
                }
                
                if (direction) {
                    scrolling = {
                        direction : direction,
                        offset : offset,
                        scroll : scroll,
                        width : width,
                        scrollbar : $scrollbar,
                        scroller : $scroller,
                        interval : setInterval(scrollPage, 200)
                    };

                    scrollPage();
                }
            })
            .live('mouseup', function(event) {
                if (scrolling && scrolling.interval) {
                    clearInterval(scrolling.interval);
                }
                
                scrolling = null;
            });
            
        $scrollers
            .live('mouseover', function(event) {
                $timers.hide();
                $tracker.hide();
            })
            .live('mousedown', function(event) {
                dragging = {
                    pageX: event.pageX,
                    scrollLeft: $grid[0].scrollLeft,
                    scroller: $(this),
                    scrollMax: $grid[0].scrollWidth - $grid[0].clientWidth - 10,
                    scrollSize: $grid[0].scrollWidth / $grid.width()
                };

                event.preventDefault();
                return false;
            });
       
        // setup grid dragging and trackers
             
        $grid.find('div.row')
            .live('mousedown', function(event) {
                dragging = {
                    mode: 'opposite',
                    pageX: event.pageX,
                    scrollLeft: $grid[0].scrollLeft,
                    scroller: null,
                    pageY: event.pageY,
                    scrollTop: $body[0].scrollTop,
                    scrollMax: $grid[0].scrollWidth - $grid[0].clientWidth - 10,
                    scrollSize: $grid[0].scrollWidth / $grid.width()
                };
                
                $tracker.hide();
                $timers.hide();

                event.preventDefault();
                return false;
            })
            .live('mousemove', function(event) {
                if (dragging) { return true; }
                if ($tracker.length == 0 && $timers.length == 0) { return true; }
                
                var offset = $grid[0].scrollLeft + event.pageX - $grid.offset().left - 10;
                    
                $tracker.css('left', (event.pageX - 10) + 'px').show();
                $timers.css('left', (event.pageX - 35) + 'px')
                       .html((Math.ceil(offset / PX_PER_SEC * 10) / 10) + 's')
                       .show();
                
                event.preventDefault();
                return false;
            });

        $document
            .mouseup(function(event) {
                if (dragging) {
                    dragging = null;
                    event.preventDefault();
                    return false;
                }
                
                if (scrolling) {
                    if (scrolling.interval) {
                        clearInterval(scrolling.interval);
                    }
                
                    scrolling = null;
                    event.preventDefault();
                    return false;
                }
            })
            .mousemove(function(event) {
                position.top = event.pageY;
                position.left = event.pageX;
                
                if (dragging) {
                    var diffX = event.pageX - dragging.pageX,
                        scrollX = diffX * dragging.scrollSize,
                        scrollLeft = dragging.scrollLeft + (dragging.mode == 'opposite' ? -scrollX : scrollX);

                    $grid[0].scrollLeft =
                        Math.min(scrollLeft, dragging.scrollMax);
                        
                    /*
                    if (typeof dragging.pageY !== 'undefined') {
                        var diffY = event.pageY - dragging.pageY,
                            scrollTop = dragging.scrollTop + (dragging.mode == 'opposite' ? -diffY : diffY);

                        $body[0].scrollTop = scrollTop;
                    }
                    */
                    
                    event.preventDefault();
                    return false;
                }
            });
            
        // setup resize handlers
        
        $(window).resize(function() {
            initialize();
        });

        $grid.data('gridlapse', { initialize : initialize });
        setTimeout(initialize, 250);
    };
    function getInstrumentationUpdates () {
        $('#loadingIndicator').show();

        var url = 'format/getInstrumentationTable';

        var buttonText = $("#buttonset-view label.ui-state-active").find('span').text();
        if ( buttonText == "Streaming" || buttonText == "Overall" || buttonText == "Both" ) {
            url += '?view=' + buttonText.toLowerCase();
        }
        var trendText = $(".trend-options a.active").attr('alt');
        if ( trendText == "Duration" || trendText == "Payload" ) {
            url += '&trend=' + trendText.toLowerCase();
        }
        var querystring = $.deparam.querystring();
        if ( querystring.sort ) {
            url += '&sort=' + querystring.sort;
        }
        if ( querystring.descending ) {
            url += '&descending=' + querystring.descending;
        }

        $.ajax({
            url: url,
            success: function (data) {
                $("#instrumentation-container").html(data);
            },
            complete: function () {
                $(".controls-wrapper .ui-button").button( "option", "disabled", false );
                $('#loadingIndicator').hide();
            }
        });
    };

    /* live dashboard */
    function getLatestCompilations () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getLatestCompilations",
            success: function (data) {
                $("#latest-compilations").find("ul").html(data);
            },
            complete: function () {
                prettyLinks();
                $('#loadingIndicator').hide();
            }
        });
    };
    function getHeaviestTemplates () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getHeaviestTemplates",
            success: function (data) {
                $("#heaviest-templates").find("ul").html(data);
            },
            complete: function () {
                $('#loadingIndicator').hide();
            }
        });
    };
    function getMostTemplateInvokes () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getMostTemplateInvokes",
            success: function (data) {
                $("#most-invokes").find("ul").html(data);
            },
            complete: function () {
                $('#loadingIndicator').hide();
            }
        });
    };
    function getSlowestTemplates () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getSlowestTemplates",
            success: function (data) {
                $("#slowest-templates").find("ul").html(data);
            },
            complete: function () {
                $('#loadingIndicator').hide();
            }
        });
    };
    function getUncompiledTemplates () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getUncompiledTemplates",
            success: function (data) {
                $("#uncompiled-templates").find("ul").html(data);
            },
            complete: function () {
                $('#loadingIndicator').hide();
            }
        });
    };
    function getStressedTemplates () {
        $('#loadingIndicator').show();
        $.ajax({
            url: "format/getStressedTemplates",
            success: function (data) {
                $("#stressed-templates").find("ul").html(data);
            },
            complete: function () {
                $('#loadingIndicator').hide();
            }
        });
    };
    function prettyLinks () {
        $('.mod-content a').each( function(i, val) {
            var timestamp = $(this).attr('timestamp');
            var datestamp = $(this).attr('datestamp');
            var parent = $(this).closest('li');

            if ( timestamp ) {
                var timeString = relative_time(timestamp);

                if ( timeString ) {
                    timeString = ' ('+timeString+')';
                    if ( $(parent).children('span.timestamp').length ) {
                        $(parent).children('span.timestamp').html(timeString);
                    } else {
                        $(parent).append('<span class="timestamp">'+timeString+'</span>');
                    }
                }
            }
        });
        $('#reload-container-history li').each( function(i, val) {
            var timestamp = $(this).attr('timestamp');

            if ( timestamp ) {
                var timeString = relative_time(timestamp);

                if ( timeString ) {
                    timeString = ' ('+timeString+')';
                    if ( $(this).children('span.timestamp').length ) {
                        $(this).children('span.timestamp').html(timeString);
                    } else {
                        $(this).append('<span class="timestamp">'+timeString+'</span>');
                    }
                }
            }
        });
    };
    // time_value:  unix timestamp in milliseconds
    function relative_time(time_value) {
        var parsed_date = new Date(parseInt(time_value));
        var relative_to = (arguments.length > 1) ? arguments[1] : new Date();
        var delta = parseInt((relative_to.getTime() - parsed_date) / 1000);

        if ( delta < 60 ) {
            return 'less than a minute ago';
        } else if ( delta < 120 ) {
            return 'about a minute ago';
        } else if ( delta < (45*60) ) {
            var value = (parseInt(delta / 60)).toString();
            var text = 'about ' + value + ' minute';
            if ( value != '1' ) {
                text += 's';
            }
            text += ' ago';
            return text;
        } else if ( delta < (90*60) ) {
            return 'about an hour ago';
        } else if ( delta < (24*60*60) ) {
            var value = (parseInt(delta / 3600)).toString();
            var text = 'about ' + value + ' hour';
            if ( value != '1' ) {
                text += 's';
            }
            text += ' ago';
            return text;
        } else if ( delta < (48*60*60) ) {
            return '1 day ago';
        } else {
            var value = (parseInt(delta / 86400)).toString();
            var text = 'about ' + value + ' day';
            if ( value != '1' ) {
                text += 's';
            }
            text += ' ago';
            return text;
        }
    };

    /* initialize */
    $(document).ready(function () {
        var serverName = window.location.host;
        $("ul.breadcrumbs .serverName").text(serverName);

		$(".accordion").accordion({ header: "h3", active: false, collapsible: true });
		$(".button").button();
		$(".buttonset").buttonset();
		$("a.button.disabled").button("disable");

		/* Dashboard */
        if ( $("#dashboard-container").length ) {
            $('#dashboard-container').sortable({
                placeholder: "span-2 ui-state-highlight"
            });
		    $('#dashboard-container').disableSelection();

            getLatestCompilations();
            setInterval(getLatestCompilations, 15000);

            getHeaviestTemplates();
            setInterval(getHeaviestTemplates, 15000);

            getMostTemplateInvokes();
            setInterval(getMostTemplateInvokes, 15000);

            getSlowestTemplates();
            setInterval(getSlowestTemplates, 15000);

            getUncompiledTemplates();
            setInterval(getUncompiledTemplates, 15000);

            getStressedTemplates();
            setInterval(getStressedTemplates, 15000);
        }
        /* Compile */
        if ( $("#reload-container").length ) {
            SyntaxHighlighter.all();
            initCompileOptions();
            getTemplateUpdates();
            templateInterval = setInterval(getTemplateUpdates, 10000);
        }
        /* Templates, Applications, and Functions */
        if ( $("#tree-container").length ) {
            initTree();
        }
        /* Logs */
        if ( $("#logs-container").length ) {
            initLogs();
        }
        /* Instrumentation */
        if ( $("#instrumentation-container").length ) {
            initInstrumentationOptions();
            setInterval(getInstrumentationUpdates, 15000);
        }
        /* Timelapse */
        if ( $("#timelapse-container").length ) {
            initTimelapseOptions();
        }
        /* Template Info */
        if ( $("#template-info-container").length ) {
            initTemplateInfoOptions();
        }
        /* System Info */
        if ( $("#system-info-container").length ) {
            initSystemInfoOptions();
        }
        /* Janitor */
        if ( $("#janitor-container").length ) {
            initJanitorOptions();
        }
        /* Viewer */
        if ( $("#template-viewer").length ) {
            initTemplateViewerOptions();
        }
    });

})(jQuery);

